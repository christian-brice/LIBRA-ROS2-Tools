# Simultaneous Localization and Mapping (SLAM) in ROS 2

This document explains how to use the LIBRA's sensor suite (RGB-D camera + spinning LIDAR) for SLAM.

## Table of Contents

- [Before You Start](#before-you-start)
- [Usage](#usage)
    - [*Terminal 1: LIBRA*](#terminal-1-libra)
    - [*Terminal 2: Nav2*](#terminal-2-nav2)
    - [*Terminal 3: slam\_toolbox*](#terminal-3-slam_toolbox)
    - [*Terminal 4: RViz*](#terminal-4-rviz)
    - [*Terminal 5: Map Generation, etc.*](#terminal-5-map-generation-etc)
- [Troubleshooting](#troubleshooting)
- [Notes](#notes)

## Before You Start

1. The communication middleware that ROS uses is DDS; specifically, [Fast DDS](https://fast-dds.docs.eprosima.com/en/latest/) by default. However, [Cyclone DDS](https://cyclonedds.io/) is recommended for MoveIt 2, Nav2, slam_toolbox, etc.
    1. Install Cyclone DDS for ROS 2.

        ```bash
        sudo apt install ros-$ROS_DISTRO-rmw-cyclonedds-cpp
        ```

    2. Add a persistent environment variable to your `.bashrc` defining Cyclone DDS as the preferred middleware.

        ```bash
        echo 'export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> ~/.bashrc
        source ~/.bashrc
        ```

2. Install required packages.

    ```bash
    sudo apt install ros-$ROS_DISTRO-navigation2 ros-$ROS_DISTRO-nav2-bringup ros-$ROS_DISTRO-pcl-ros ros-$ROS_DISTRO-slam-toolbox
    ```

    - Optionally, install Turtlebot3 packages if you want to experiment in simulated environments. Don't forget to pick a default Turtlebot model.

        ```bash
        sudo apt install ros-humble-turtlebot3*
        echo 'export TURTLEBOT3_MODEL=waffle' >> ~/.bashrc
        ```

## Usage

TODO: ***the following are in-progress notes - none of this really works yet!***

### *Terminal 1: LIBRA*

We only want to set up the joint and robot state publishers; RViz is opened in [Terminal 4: RViz](#terminal-4-rviz).

```bash
cd ros2_ws/ && . install/local_setup.bash
ros2 launch libra sensor_suite.launch.py use_rviz:=false
```

### *Terminal 2: Nav2*

```bash
cd ros2_ws/ && . install/local_setup.bash
ros2 launch nav2_bringup navigation_launch.py
```

### *Terminal 3: slam_toolbox*

```bash
cd ros2_ws/ && . install/local_setup.bash
ros2 launch slam_toolbox online_async_launch.py
```

### *Terminal 4: RViz*

```bash
cd ros2_ws/ && . install/local_setup.bash
ros2 run rviz2 rviz2 -d src/libra/rviz/nav2_custom.rviz
```

Once RViz has initialized, check the Displays tab for the following.

- `Realsense` should be enabled.
- `Global Planner` and `Controller` (local planner) can be disabled to better understand the map generated by slam_toolbox.

### *Terminal 5: Map Generation, etc.*

Nav2 only supports creation of occupancy grids (`nav_msgs/msg/OccupancyGrid`).
The following command will generate two files: a metadata YAML file and a PGM image file where white, gray, and black pixels represent the free, occupied, and unknown spaces, respectively.

```bash
cd ros2_ws/
mkdir maps && cd maps/
ros2 run nav2_map_server map_saver_cli
```

- `-f <filename>`: specify an output destination.

## Troubleshooting

(none)

## Notes

Resources:

- ["ROS2 Nav2 â€“ Generate a Map with slam_toolbox"](https://roboticsbackend.com/ros2-nav2-generate-a-map-with-slam_toolbox/) by The Robotics Back-End
